<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
html, body {margin: 0;height: 100%;overflow: hidden;background: #000;}
#idPlayer {
	position: fixed;
	inset: 0;
	width: 100vw;
	height: 100vh;
	border: 0;
}
#msg {
	position: fixed;
	inset: 0;
	display: grid;
	place-items: center;
	color: #fff;
	text-align: center;
	padding: 2rem;
}
#msg code {background: #222; padding: .2em .4em; border-radius: .3em;}
</style>
</head>
<body>
<div id="msg" hidden></div>
<div id="idPlayer"></div>
<script src="libs/embed/yt0.js"></script>
<script>
let gyt = null

/** メッセージ表示 */
function showMessage(text){
	const msg = document.getElementById('msg')
	msg.textContent = ''
	msg.insertAdjacentHTML("afterbegin", text)
	msg.hidden = false
	document.getElementById('idPlayer').hidden = true
}

window.addEventListener('message', (e) => {
	//if (e.origin !== 'https://parent.example.org') return; // 安全確認
	//console.log('受信:', e.data)
	const k = e.data.m, ifId = e.data?.ifId || null
	switch ( k ) {
		/*case 'play':
			iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
			break
		case 'pause':
			iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
			break;*/
		case 'state':
			gyt.ytPlayState()
			break
		case 'togglePlay':
			gyt.ytTogglePlay()
			break
		case 'play':
			gyt.ytPlay()
			break
		case 'pause':
			gyt.ytPause()
			break
		case 'stop':
			gyt.ytStop()
			break
		case 'rateup': case 'ratedown':
			{
				const rate = gyt.ytGetRate() + (k=='rateup' ? .25 : -.25)
				gyt.ytRate({rate})
				//ctlEl.find('.curRate').text( gyt.ytGetRate().toFixed(2) )
			}
			break
		case 'rate':
			{
				const rate = parseFloat(e.data.rate) || 1
				gyt.ytRate({rate})
			}
			break
		case 'sendRate':
			{
				const rate = gyt.ytGetRate().toFixed(2)
				window.parent.postMessage({ifId, m:'sendRate', rate}, '*')
			}
			break
		case 'forward': case 'backward':
			{
				let sec = k=='forward' ? 3 : -3
				const rate = gyt.ytGetRate()
				if ( rate < 1 )
					sec = Number((sec * rate).toFixed(2))
				gyt.ytSeek({sec})
			}
			break
	}
})


class YT_c {
	constructor({vId, ifId, bAuto=false}){
		//const src = `https://www.youtube.com/embed/${vId}?loop=1&iv_load_policy=3&modestbranding=1&showinfo=0&rel=0&enablejsapi=1`
		this._player = null
		this.loadYTVid({vId, ifId, bAuto})
	}
	ytPlay(){ this._player?.playVideo() }
	ytPause(){ this._player?.pauseVideo() }
	ytStop(){ this._player?.stopVideo() }
	ytPlayState(){
		const state = this._player?.getPlayerState();
		// -1:未開始 0:終了 1:再生中 2:一時停止 3:バッファリング 5:動画の頭出し
		//console.log('State:', state);
		if ( state == 1 || state == 3 )//再生中またはバッファリング中
			return true
		return false
	}
	ytTogglePlay(){
		if ( !this._player?.getPlayerState )
			return false
		const state = this._player.getPlayerState();
		if ( state == 1 || state == 3 ){//再生中またはバッファリング中
			this._player?.pauseVideo()
			return true
		} else
			this._player?.playVideo()
		return false
	}
	ytRate({rate}){
		rate = Number(parseFloat(rate).toFixed(2))
		if ( rate < 0.1 ) rate = 0.1
		else if ( rate > 4 ) rate = 4
		console.log('Set rate: ', rate)
		this._player?.setPlaybackRate(rate);
	}
	ytGetRate(){ return parseFloat(this._player?.getPlaybackRate()) || 1 }
	ytDuration(){ return this._player?.getDuration() || 0 }
	ytCurTime(){ return this._player?.getCurrentTime() || 0 }
	ytSeek({sec}){
		sec = Number(parseFloat(sec).toFixed(2))
		if ( isNaN(sec) ) sec = 0
		const dur = this.ytDuration()
		let cur = this.ytCurTime()
		cur += sec
		if ( cur < 0 ) cur = 0
		else if ( dur > 0 && cur > dur ) cur = dur - 1
		this._player?.seekTo( cur, true );
	}
	loadYTVid({vId, ifId, bAuto=false}){
		this._player = new YT.Player( 'idPlayer', {
			//width: "240", height: "360",
			videoId: vId, // 任意の動画ID
			playerVars: { //https://developers.google.com/youtube/player_parameters
				controls: 1, // 標準UIを表示
				rel: 0,
				//loop: 1,//iframeだと動作しないことがあるので無効に
				//enablejsapi: 1,
				playsinline: 1,
				iv_load_policy: 3,
				autoplay: bAuto ? 1 : 0,
				mute: 0,
				rel: 0,
			},
			events: {
				onReady: (e) => {
					//console.log("Player ready");
				},
				onStateChange: (e) => {
					const state = e.data
					//console.log("State:", state);
					if ( state == YT.PlayerState.ENDED )//終了
					{
						{//ループモードなら次の動画へ
							this.sendMsg({tp:'nextVideo', ifId})
						}
						
						{//ループモードでないなら、同じ動画のループ開始
							this.ytSeek({sec:0})
							this.ytPlay()
						}
					}

					if ( state == YT.PlayerState.PLAYING || state == YT.PlayerState.BUFFERING )//再生中
						this.sendMsg({tp:'playing', ifId})
					else
						this.sendMsg({tp:'paused', ifId})
				},
				onError: (e) => {
					const state = e.data
					console.error("Error:", state);
					this.sendMsg({tp:'error', ifId})
				}
			}
		});
	}
	sendMsg({tp, ifId}){
		window.parent.postMessage({m:'yt_'+tp, ifId}, '*')
	}
}

function onYouTubeIframeAPIReady(){
	const params = new URLSearchParams(location.search)
	const vId = params.get('v'), ifId = params.get('ifId'), bAuto = params.get('auto') == '1'

	if (!vId || !ifId)
		return
	
	const YT_ID_RE = /^[A-Za-z0-9_-]{11}$/
	if (!YT_ID_RE.test(vId)){
		showMessage('不正な動画IDです。<br>11文字の YouTube 動画IDを指定してください。<br>例: <code>dQw4w9WgXcQ</code>')
		return
	}
	gyt = new YT_c({vId, ifId, bAuto})
}
</script>
</body>
</html>